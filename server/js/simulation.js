// Generated by CoffeeScript 1.3.1
(function() {
  var B, Dynamic, Game, Player, levels, root,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor; child.__super__ = parent.prototype; return child; },
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  levels = ['[{"x":552,"y":358,"w":160,"h":86},{"x":-2,"y":-5,"w":16,"h":790},{"x":100,"y":667,"w":450,"h":40},{"x":786,"y":-22,"w":16,"h":818},{"x":5,"y":-1,"w":795,"h":33},{"x":4,"y":767,"w":795,"h":33},{"x":237,"y":87,"w":318,"h":46},{"x":175,"y":633,"w":34,"h":30,"dynamic":true,"cs":["purp"]},{"x":9,"y":435,"w":143,"h":42},{"x":178,"y":321,"w":126,"h":37},{"x":648,"y":501,"w":143,"h":42},{"x":437,"y":332,"w":281,"h":21,"dynamic":true,"cs":["purp"]},{"x":215,"y":631,"w":34,"h":30,"dynamic":true,"cs":["purp"]},{"x":196,"y":596,"w":34,"h":30,"dynamic":true,"cs":["purp"]},{"x":238,"y":597,"w":34,"h":30,"dynamic":true,"cs":["purp"]},{"x":256,"y":630,"w":34,"h":30,"dynamic":true,"cs":["purp"]},{"x":406,"y":633,"w":34,"h":30,"dynamic":true,"cs":["purp"]},{"x":185,"y":285,"w":34,"h":30,"dynamic":true,"cs":["purp"]},{"x":185,"y":252,"w":34,"h":30,"dynamic":true,"cs":["purp"]},{"x":432,"y":188,"w":145,"h":46}] ', '[]', '[]', '[{"x":341,"y":996,"w":0,"h":0},{"x":-14,"y":187,"w":286,"h":1737},{"x":1044,"y":170,"w":318,"h":1753},{"x":-1,"y":-1,"w":1402,"h":225},{"x":402,"y":305,"w":472,"h":45},{"x":263,"y":397,"w":101,"h":50},{"x":426,"y":514,"w":156,"h":46},{"x":701,"y":401,"w":53,"h":63},{"x":1482,"y":502,"w":20,"h":20},{"x":266,"y":640,"w":99,"h":151},{"x":352,"y":734,"w":504,"h":57},{"x":619,"y":1299,"w":430,"h":41},{"x":933,"y":875,"w":121,"h":274},{"x":755,"y":1008,"w":20,"h":39},{"x":394,"y":1298,"w":40,"h":39},{"x":814,"y":607,"w":161,"h":56},{"x":576,"y":992,"w":346,"h":10,"dynamic":true,"cs":["purp"]},{"x":263,"y":898,"w":168,"h":41},{"x":257,"y":1732,"w":795,"h":192},{"x":439,"y":494,"w":0,"h":0,"type":"collect"},{"x":404,"y":239,"w":468,"h":37,"type":"spawn"},{"x":454,"y":494,"w":0,"h":0,"type":"collect"},{"x":485,"y":494,"w":0,"h":0,"type":"collect"},{"x":728,"y":383,"w":0,"h":0,"type":"collect"},{"x":713,"y":383,"w":0,"h":0,"type":"collect"},{"x":815,"y":587,"w":0,"h":0,"type":"collect"},{"x":830,"y":587,"w":0,"h":0,"type":"collect"},{"x":1017,"y":252,"w":0,"h":0,"type":"collect"},{"x":277,"y":877,"w":0,"h":0,"type":"collect"},{"x":292,"y":877,"w":0,"h":0,"type":"collect"},{"x":323,"y":877,"w":0,"h":0,"type":"collect"},{"x":293,"y":836,"w":0,"h":0,"type":"collect"},{"x":324,"y":836,"w":0,"h":0,"type":"collect"},{"x":278,"y":836,"w":0,"h":0,"type":"collect"},{"x":285,"y":1282,"w":258,"h":8,"dynamic":true,"cs":["purp"]},{"x":529,"y":1477,"w":10,"h":251,"dynamic":true,"cs":["purp"]},{"x":585,"y":1474,"w":10,"h":251,"dynamic":true,"cs":["purp"]},{"x":643,"y":1475,"w":10,"h":251,"dynamic":true,"cs":["purp"]},{"x":712,"y":1472,"w":10,"h":251,"dynamic":true,"cs":["purp"]},{"x":789,"y":1425,"w":160,"h":299},{"x":980,"y":1484,"w":0,"h":0,"type":"collect"},{"x":965,"y":1484,"w":0,"h":0,"type":"collect"},{"x":1012,"y":1483,"w":0,"h":0,"type":"collect"},{"x":1027,"y":1483,"w":0,"h":0,"type":"collect"},{"x":978,"y":1527,"w":0,"h":0,"type":"collect"},{"x":963,"y":1527,"w":0,"h":0,"type":"collect"},{"x":1010,"y":1526,"w":0,"h":0,"type":"collect"},{"x":1025,"y":1526,"w":0,"h":0,"type":"collect"},{"x":1010,"y":1575,"w":0,"h":0,"type":"collect"},{"x":978,"y":1576,"w":0,"h":0,"type":"collect"},{"x":963,"y":1576,"w":0,"h":0,"type":"collect"},{"x":1025,"y":1575,"w":0,"h":0,"type":"collect"},{"x":1019,"y":1279,"w":0,"h":0,"type":"collect"},{"x":1004,"y":1279,"w":0,"h":0,"type":"collect"},{"x":313,"y":1657,"w":0,"h":0,"type":"collect"},{"x":298,"y":1657,"w":0,"h":0,"type":"collect"},{"x":294,"y":1250,"w":0,"h":0,"type":"collect"},{"x":329,"y":1229,"w":0,"h":0,"type":"collect"},{"x":862,"y":843,"w":0,"h":0,"type":"collect"},{"x":827,"y":864,"w":0,"h":0,"type":"collect"},{"x":319,"y":1434,"w":40,"h":39},{"x":425,"y":1500,"w":40,"h":39},{"x":394,"y":1655,"w":40,"h":39}] ', '[]'];

  B = require('./libs/Box2dWeb-2.1.a.3.js');

  Array.prototype.remove = function(item) {
    var indx;
    indx = this.indexOf(item);
    if (indx !== -1) {
      return this.splice(indx, 1);
    }
  };

  root = typeof exports !== "undefined" && exports !== null ? exports : this;

  root.randint = function(max) {
    return parseInt(Math.random() * max);
  };

  root.IDcounter = 0;

  root.getID = function() {
    root.IDcounter += 1;
    return root.IDcounter;
  };

  root.requestAnimFrame = (function() {
    return function(callback) {
      return setTimeout(callback, 1000 / 60);
    };
  })();

  Dynamic = (function() {

    Dynamic.name = 'Dynamic';

    function Dynamic() {
      this.ID = root.getID();
      this.x = (root.randint(700)) + 50;
      this.y = 600;
      this.w = 10;
      this.h = 30;
      this.dynamic = true;
      this.cache = {
        x: -9999,
        y: -9999,
        d: 0
      };
    }

    Dynamic.prototype.get_delta = function() {
      var result;
      result = {};
      if (Math.abs(this.x - this.cache.x) >= 1.0) {
        this.cache.x = this.x;
        result.x = this.x;
      }
      if (Math.abs(this.y - this.cache.y) >= 1.0) {
        this.cache.y = this.y;
        result.y = this.y;
      }
      if (Math.abs(this.d - this.cache.d) >= 1.0) {
        this.cache.d = this.d;
        return result.d = this.d;
      }
    };

    Dynamic.prototype.state = function() {
      var pos;
      this.degrees = this.body.GetAngle() * (180 / Math.PI);
      pos = this.body.GetPosition();
      this.x = pos.x * root.game.scale - this.w / 2;
      this.y = -pos.y * root.game.scale - this.h / 2;
      return {
        t: this.dynamic,
        ID: this.ID,
        x: this.x,
        y: this.y,
        w: this.w,
        h: this.h,
        cs: this.cs,
        d: this.degrees
      };
    };

    Dynamic.prototype.delta_state = function() {
      var delta, jj, key, pos;
      this.degrees = this.body.GetAngle() * (180 / Math.PI);
      pos = this.body.GetPosition();
      this.x = pos.x * root.game.scale - this.w / 2;
      this.y = -pos.y * root.game.scale - this.h / 2;
      delta = this.get_delta();
      jj = 0;
      for (key in delta) {
        jj += 1;
      }
      return {
        ID: this.ID,
        t: this.dynamic,
        x: this.x,
        y: this.y,
        w: this.w,
        h: this.h,
        cs: this.cs,
        d: this.degrees
      };
    };

    return Dynamic;

  })();

  Player = (function(_super) {

    __extends(Player, _super);

    Player.name = 'Player';

    function Player(connection) {
      var spawn;
      this.connection = connection;
      this.ID = root.getID();
      spawn = root.game.spawn;
      this.x = (root.randint(spawn.w)) + spawn.x;
      this.y = (root.randint(spawn.h)) + spawn.y;
      this.w = 10;
      this.h = 30;
      this.dynamic = false;
      this.name = 'anon';
      this.keys = [];
      this.contacts = [];
      this.on_ground = 0;
      this.head_clear = true;
      this.max_force = 4;
      this.max_velocity = 3.0;
      this.max_jump = 5.5;
      this.speed = .7;
    }

    Player.prototype.delta_state = function() {
      var pos;
      this.degrees = this.body.GetAngle() * (180 / Math.PI);
      pos = this.body.GetPosition();
      this.x = pos.x * root.game.scale - this.w / 2;
      this.y = -pos.y * root.game.scale - this.h / 2;
      return {
        ID: this.ID,
        t: this.dynamic,
        x: this.x,
        y: this.y,
        w: this.w,
        h: this.h,
        name: this.name,
        color: this.color,
        d: this.degrees
      };
    };

    Player.prototype.state = function() {
      var pos;
      this.degrees = this.body.GetAngle() * (180 / Math.PI);
      pos = this.body.GetPosition();
      this.x = pos.x * root.game.scale - this.w / 2;
      this.y = -pos.y * root.game.scale - this.h / 2;
      return {
        t: this.dynamic,
        ID: this.ID,
        x: this.x,
        y: this.y,
        w: this.w,
        h: this.h,
        name: this.name,
        color: this.color,
        d: this.degrees
      };
    };

    Player.prototype.send = function(obj) {
      try {
        return this.connection.send(JSON.stringify(obj));
      } catch (error) {
        return console.log('ERROR, failure to send player socket');
      }
    };

    Player.prototype.keydown = function(code) {
      this.keys.push(code);
      if (code === 32) {
        if (this.on_ground) {
          return this.apply_velocity(0, this.max_jump, true);
        }
      }
    };

    Player.prototype.keyup = function(code) {
      if (__indexOf.call(this.keys, code) >= 0) {
        return this.keys.remove(code);
      }
    };

    Player.prototype.apply_velocity = function(x, y, override) {
      var max, v, vel;
      if (x == null) {
        x = 0;
      }
      if (y == null) {
        y = 0;
      }
      if (override == null) {
        override = false;
      }
      vel = this.body.GetLinearVelocity();
      max = this.max_velocity;
      x = x + vel.x;
      y = y + vel.y;
      if (!override) {
        if (Math.abs(x) > max) {
          x *= max / Math.abs(x);
        }
        if (Math.abs(y) > max) {
          y *= max / Math.abs(y);
        }
      }
      try {
        v = new B.b2Vec2(x, y);
        return this.body.SetLinearVelocity(v);
      } catch (error) {
        return console.log('ERROR: ', B);
      }
    };

    Player.prototype.apply_force = function(x, y) {
      var p, v, vel;
      vel = this.body.GetLinearVelocity();
      x = x * this.max_force;
      y = y * this.max_force;
      v = new B.Common.Math.b2Vec2(x, y);
      p = this.body.GetWorldCenter();
      return this.body.ApplyForce(v, p);
    };

    Player.prototype.update = function() {
      this.on_ground -= .1;
      if (this.on_ground > 0) {
        this.on_ground -= .1;
      } else {
        this.on_ground = 0;
      }
      this.body.m_sweep.a = 0;
      if (__indexOf.call(this.keys, 37) >= 0) {
        if (this.on_ground) {
          this.apply_velocity(-this.speed, 0.0);
        } else {
          this.apply_velocity(-.3, 0.0);
        }
      }
      if (__indexOf.call(this.keys, 39) >= 0) {
        if (this.on_ground) {
          return this.apply_velocity(this.speed, 0.0);
        } else {
          return this.apply_velocity(.3, 0.0);
        }
      }
    };

    Player.prototype.contact_add = function(entity, point) {};

    Player.prototype.contact_begin = function(entity, point) {};

    Player.prototype.contact_persist = function(entity, point) {
      if (point.normal != null) {
        if (point.normal.y > .5) {
          return this.on_ground = 1.0;
        }
      }
    };

    Player.prototype.contact_remove = function(entity, point) {};

    return Player;

  })(Dynamic);

  Game = (function() {

    Game.name = 'Game';

    function Game() {
      var gravity, worldAABB;
      this.scale = 100.0;
      this.mode = 'lobby';
      this.level = 3;
      this.players = [];
      this.dynamics = [];
      this.spawn = {
        x: 50,
        y: 500,
        w: 700,
        h: 100
      };
      worldAABB = new B.b2AABB();
      worldAABB.lowerBound.Set(-60.0, -60.0);
      worldAABB.upperBound.Set(60.0, 60.0);
      gravity = new B.b2Vec2(0.0, -10.0);
      this.world = new B.b2World(worldAABB, gravity, true);
      this.boxes = [];
      this.load_level(this.level);
      console.log(new B.b2ContactListener());
      this.ContactListener = new B.b2ContactListener();
      this.ContactListener.Add = this.contact_begin;
      this.ContactListener.Persist = this.contact_persist;
      this.ContactListener.Remove = this.contact_remove;
      this.world.SetContactListener(this.ContactListener);
      this.mode_time = this.time();
    }

    Game.prototype.time = function() {
      var d;
      d = new Date();
      return d.getTime();
    };

    Game.prototype.contact_add = function(point) {
      var ab;
      ab = root.game.get_contact_entities(point);
      if (ab[0]) {
        ab[0].contact_add(ab[1], point);
      }
      if (ab[1]) {
        return ab[1].contact_add(ab[0], point);
      }
    };

    Game.prototype.contact_begin = function(point) {
      var ab;
      ab = root.game.get_contact_entities(point);
      if (ab[0]) {
        ab[0].contact_begin(ab[1], point);
      }
      if (ab[1]) {
        return ab[1].contact_begin(ab[0], point);
      }
    };

    Game.prototype.contact_persist = function(point) {
      var ab;
      ab = root.game.get_contact_entities(point);
      if (ab[0]) {
        ab[0].contact_persist(ab[1], point);
      }
      if (ab[1]) {
        return ab[1].contact_persist(ab[0], point);
      }
    };

    Game.prototype.contact_remove = function(point) {
      var ab;
      ab = root.game.get_contact_entities(point);
      if (ab[0]) {
        ab[0].contact_remove(ab[1], point);
      }
      if (ab[1]) {
        return ab[1].contact_remove(ab[0], point);
      }
    };

    Game.prototype.get_contact_entities = function(point) {
      var first, next, result;
      first = point.shape1.m_body;
      next = point.shape2.m_body;
      result = [false, false];
      if (first.GetUserData()) {
        result[0] = first.GetUserData();
      }
      if (next.GetUserData()) {
        result[1] = next.GetUserData();
      }
      return result;
    };

    Game.prototype.load_level = function(n) {
      var data, obj, _i, _len, _results;
      this.debug = [];
      if (n < levels.length) {
        data = JSON.parse(levels[n]);
        _results = [];
        for (_i = 0, _len = data.length; _i < _len; _i++) {
          obj = data[_i];
          if (obj.type != null) {
            if (obj.type === 'spawn') {
              _results.push(this.spawn = obj);
            } else {
              _results.push(void 0);
            }
          } else if (obj.dynamic != null) {
            _results.push(this.boxes.push(this.make_dynamic_box(obj)));
          } else {
            _results.push(this.boxes.push(this.make_static_box(obj)));
          }
        }
        return _results;
      }
    };

    Game.prototype.make_dynamic_box = function(obj) {
      var body, bodyDef, new_dynamic, shapeDef;
      new_dynamic = new Dynamic();
      new_dynamic.w = obj.w;
      new_dynamic.h = obj.h;
      new_dynamic.cs = obj.cs;
      this.dynamics.push(new_dynamic);
      bodyDef = new B.b2BodyDef();
      bodyDef.allowSleep = false;
      bodyDef.type = B.b2Body.b2_dynamicBody;
      bodyDef.position.Set((obj.x + obj.w / 2) / this.scale, -1 * (obj.y + obj.h / 2) / this.scale);
      body = this.world.CreateBody(bodyDef);
      shapeDef = new B.b2PolygonDef();
      shapeDef.SetAsBox(obj.w / 2 / this.scale, obj.h / 2 / this.scale);
      shapeDef.density = 1.0;
      shapeDef.friction = 0.3;
      shapeDef.restitution = .2;
      body.CreateShape(shapeDef);
      body.SetMassFromShapes();
      new_dynamic.body = body;
      console.log(body.GetAngle());
      return body;
    };

    Game.prototype.make_static_box = function(obj) {
      var groundBody, groundBodyDef, groundShapeDef;
      groundBodyDef = new B.b2BodyDef();
      groundBodyDef.position.Set((obj.x + obj.w / 2) / this.scale, (-1 * (obj.y + obj.h / 2)) / this.scale);
      groundBody = this.world.CreateBody(groundBodyDef);
      groundShapeDef = new B.b2PolygonDef();
      groundShapeDef.friction = 0.3;
      groundShapeDef.restitution = .2;
      groundShapeDef.SetAsBox((obj.w / 2) / this.scale, (obj.h / 2) / this.scale);
      groundBody.CreateShape(groundShapeDef);
      return groundBody;
    };

    Game.prototype.update = function() {
      root.game.world.Step(1.0 / 60.0, 5);
      root.game.update_players();
      return root.requestAnimFrame(root.game.update);
    };

    Game.prototype.update_players = function() {
      var d, dset, p, set, _i, _j, _k, _len, _len1, _len2, _ref, _ref1, _ref2, _results;
      set = [];
      dset = [];
      _ref = this.players;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        p = _ref[_i];
        set.push(p.delta_state());
      }
      _ref1 = this.dynamics;
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        d = _ref1[_j];
        set.push(d.delta_state());
      }
      this.broadcast({
        debrief: set
      });
      _ref2 = this.players;
      _results = [];
      for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
        p = _ref2[_k];
        _results.push(p.update());
      }
      return _results;
    };

    Game.prototype.new_connection = function(ws, login) {
      var body, bodyDef, ddd, new_player, ppp, shapeDef;
      new_player = new Player(ws);
      new_player.name = login.name;
      new_player.color = login.color;
      ws.player = new_player;
      this.players.push(new_player);
      bodyDef = new B.b2BodyDef();
      bodyDef.allowSleep = false;
      bodyDef.type = B.b2Body.b2_dynamicBody;
      bodyDef.position.Set((new_player.x + new_player.w / 2) / this.scale, -1 * (new_player.y + new_player.h / 2) / this.scale);
      body = this.world.CreateBody(bodyDef);
      shapeDef = new B.b2PolygonDef();
      shapeDef.SetAsBox(new_player.w / 2 / this.scale, new_player.h / 2 / this.scale);
      shapeDef.density = 1.0;
      shapeDef.friction = 0.3;
      shapeDef.restitution = .2;
      body.CreateShape(shapeDef);
      body.SetMassFromShapes();
      new_player.body = body;
      body.SetUserData(new_player);
      this.broadcast({
        connect: [new_player.state()]
      });
      new_player.send({
        load: this.level
      });
      new_player.send({
        self: new_player.ID
      });
      ppp = this.players.map(function(p) {
        return p.state();
      });
      ddd = this.dynamics.map(function(p) {
        return p.state();
      });
      return new_player.send({
        debrief: ppp.concat(ddd)
      });
    };

    Game.prototype.broadcast = function(message) {
      var p, _i, _len, _ref, _results;
      _ref = this.players;
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        p = _ref[_i];
        _results.push(p.send(message));
      }
      return _results;
    };

    return Game;

  })();

  root.Player = Player;

  root.game = new Game();

  root.game.update();

}).call(this);
